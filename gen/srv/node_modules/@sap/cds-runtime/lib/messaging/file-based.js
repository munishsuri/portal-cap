const { resolve } = require('path')
const { emit, init, watch } = require('./file-based-utils/client')
const cds = global.cds || require('@sap/cds/lib')

const MessagingService = require('./service')
// REVISIT: no console
const _error = console.error

const LOG = cds.log('messaging')

class FileBasedMessaging extends MessagingService {
  async init () {
    const file = this.options.file || (this.options.file = '~/.cds-msg-box')
    this.file = resolve(file.replace(/^~/, () => require('os').userInfo().homedir))
    this.lock = `${this.file}.lock`
    this.status = { active: true, lastCtimeMs: 0 }
    this.subscriptions = new Set()
    cds.once('listening', () => {
      this.ready = true
      this.listen()
    })

    await init(this.file, this.lock)
    return super.init()
  }

  async emit (event, ...etc) {
    const msg = this.message4(event, ...etc)
    LOG._debug && LOG.debug('Emit', { topic: msg.event, file: this.file })
    return emit(msg, this.file, this.lock)
  }

  // inbound -> listen to channel (once)
  async on (topic, handler) {
    this.subscriptions.add(topic)
    if (this.subscriptions.size === 1) this.listen()
    return super.on(topic, handler)
  }

  listen () {
    if (!this.listening && this.ready && this.subscriptions.size > 0) {
      this.listening = true
      // REVISIT: no console
      // console.log('[cds] - Watch', { file: this.file }) // no std trace output by non-CLI components please
      watch(this.file, this.lock, this.subscriptions, this.status, async msg => {
        try {
          await super.emit({ ...msg, inbound: true })
        } catch (e) {
          _error(e)
        }
      })
    }
  }

  disconnect () {
    this.status.active = false
  }
}

module.exports = FileBasedMessaging
