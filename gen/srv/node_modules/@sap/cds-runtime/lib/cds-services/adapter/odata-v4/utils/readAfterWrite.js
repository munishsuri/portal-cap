const cds = global.cds || require('@sap/cds/lib')
const { SELECT } = cds.ql

const { getDeepSelect } = require('../../../services/utils/handlerUtils')
const { DRAFT_COLUMNS } = require('../../../../common/constants/draft')

const _getColumns = target =>
  Object.keys(target.elements).filter(
    k =>
      target.elements[k].type !== 'cds.Association' &&
      target.elements[k].type !== 'cds.Composition' &&
      !target.elements[k].virtual &&
      !DRAFT_COLUMNS.includes(k) // > getDeepSelect() does the same
  )

module.exports = (req, srv) => {
  if (req.event === 'UPDATE') {
    return cds.tx(req).run(SELECT.from(req.query.UPDATE.entity, _getColumns(req.target)))
  }

  return cds.tx(req).run(getDeepSelect(req, srv.model.definitions))
}
